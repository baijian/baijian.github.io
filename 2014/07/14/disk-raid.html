<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>disk-raid</title>
        <meta name="viewport" content="width=device-width">

        <!-- syntax highlighting CSS -->
        <link rel="stylesheet" href="/css/syntax.css">

        <!-- Custom CSS -->
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/">Too young too simple and too naive</a></h1>
            <a class="extra" href="/">home</a>
            <a class="extra" href="/recomend.html">阿里内推</a>
          </div>

          <h2>disk-raid</h2>
<p class="meta">14 Jul 2014</p>

<div class="post">
<p>raid分为硬raid和软raid两种</p>

<h3>软raid</h3>

<p>umount /dev/md0
mdadm -S /dev/md0
mdadm --zero-superblock /dev/sdi1
mdadm --zero-superblock /dev/sdj1</p>

<p>mdadm create /dev/md0 --level=5 --raid-devices=5 /dev/sd[bcdef]1 --spare-devices=2 /dev/sd[gh]1</p>

<p>mkfs.ext4 /dev/md0</p>

<p>mdadm -D /dev/md0
mdadm -Ds (查看md0的UUID状态)
cat /proc/mdstat
mdadm --detail --scan
mdadm --examine --scan</p>

<p>安装软raid</p>

<p>rpm -ivh mdadm-1.6.0-3.rpm</p>

<p>模式:
mdadm有6种模式，前两种模式：Create、Assemble用于配置和激活阵列；Manage模式用于操作在活动阵列中的设备；Follow或Monitor模式允许管理员对活动阵列配置事件提醒和动作；Build模式用于对旧阵列使用旧版本的md驱动；还有Grow模式可以扩展阵列；剩下的是Misc模式，它包括对多种内部的任务和没有指定特殊模式的一些操作</p>

<p>mdadm --create --verbose /dev/md0 --level=0 --raid-device=3 /dev/sdb1 /dev/sdc1 /dev/sdd1
or 
mdadm -Cv /dev/md0 -l0 -n3 /dev/sd{b,c,d}1</p>

<p>mkfs.ext3 /dev/md0
mount /dev/md0 /disk1</p>

<p>cat /etc/proc/mdstat</p>

<p>mdadm --detail /dev/md0
mdadm -S /dev/md0</p>

<p>mdadm -A /dev/md0 /dev/sd{b,c,d}1</p>

<p>检测
mdadm -E /dev/sdb1
然后根据uuid装配
mdadm -Av /dev/md0 --uuid=xxx /dev/sd*</p>

<p>mdadm /dev/md0 --add /dev/sdc1</p>

<p>监控
nohup mdadm --monitor --mail=sysadmin --delay=300 /dev/md0 &amp;</p>

<p>删除软raid:先删除RAID中的所有设备,然后停止该RAID即可</p>

<p>mdadm /dev/md0 --fail /dev/sdb --remove /dev/sdb
mdadm /dev/md0 --fail /dev/sdc --remove /dev/sdc
mdadm /dev/md0 --fail /dev/sdd --remove /dev/sdd</p>

<p>mdadm --stop /dev/md0 </p>

<p>mdadm --misc --zero-superblock /dev/sdb
mdadm --misc --zero-superblock /dev/sdc
mdadm --misc --zero-superblock /dev/sdd</p>

<p>rm -f /etc/mdadm.conf
rm -f /etc/raidtab
vim /etc/rc.sysinit+/raid\c</p>

<p>mdadm --remove /dev/md127 /dev/sdg
    mdadm --zero-superblock /dev/sdg
mdadm --manage /dev/md127 --add /dev/sdg</p>

<p>1.查看RAID的信息
mdadm –detail /dev/md0
这里包含RAID的详细信息</p>

<p>2.删除和恢复某个RAID磁盘(假设使用hda1)
    先删除某个磁盘：
    mdadm /dev/md0 -f /dev/hda1—–标记错误磁盘
    mdadm /dev/md0 -r /dev/hda1—–去除错误磁盘</p>
<div class="highlight"><pre><code class="text language-text" data-lang="text">恢复之前删除的磁盘
mdadm /dev/md0 -a /dev/hda1

此时查看RAID信息可以看到/dev/hda1自动成为了热备盘

3.扩展已有的RAID
这里先创建要添加的RAID分区：/dev/hdd1
添加磁盘
mdadm –add /dev/md0 /dev/hdd1
此时md0中增加了一个spare磁盘，接下来就是扩展了
mdadm –grow /dev/md0 –raid-devices=4
这里在grow模式下增加了设备，也可以增加设备容量
fsck.ext3 /raid
校验文件系统，为扩展作准备
resize2fs /raid
扩展文件系统，更新系统信息

4.创建RAID控制文件
echo DEVICE /dev/hd[a-d]1 &gt;&gt; /etc/mdadm.conf
mdadm -Ds &gt;&gt; /etc/mdadm.conf
此时可以看到配置文件如下：
DEVICE /dev/hda1 /dev/hdb1 /dev/hdc1 /dev/hdd1
ARRAY /dev/md0 level=raid5 num-devices=4
UUID = 9ca85577:25660a81:67152b19:3235d3s6

5.控制RAID起停
mdadm -S /dev/md0—–停止raid
怎么启动RAID呢？
如果已经配置了RAID控制文件，则
mdadm -As /dev/md0
根据配置文件的描述，RAID自动启动
如果没有配置文件
mdadm -As /dev/md0 /dev/hd[a-d]1
此时给出RAID的构成盘，RAID启动成功

linux做实验时创建了软raid. 后来重新创建raid时 提示如下
[root@client ~]# mdadm -C /dev/md0 -l 1 -n 2 /dev/sdb5 /dev/sdb6
mdadm: another array by this name is already running.

[root@client ~]# mdadm -S /dev/md0
mdadm: stopped /dev/md0
[root@client ~]# mdadm -D /dev/md0
mdadm: md device /dev/md0 does not appear to be active.

然后就可以创建raid了.

mdadm -S, –stop
deactivate array, releasing all resources.

有些情况还是不行
mdadm -S /dev/md0
mdadm -D /dev/md0
需要重启后生效.
</code></pre></div>
</div>



<section>
<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'baijian'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
 var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
 dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
 (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
 })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

</section>




          

    </body>
    
        <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-49477407-1', 'joinjoy.me');
    ga('send', 'pageview');

</script>

    
</html>
